package com.example.MovieService.service;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import com.example.MovieService.Iservice.MovieService;
import com.example.MovieService.dto.RequestMovie;
import com.example.MovieService.model.Movie;
import com.example.MovieService.model.People;

@Service
public class ImpMovieService implements MovieService {

	@Value("${api.film-url}")
	private String url;
	
	@Value("${api.people-url}")
	private String peopleUrl;
	
	private final RestTemplate restTemplate = new RestTemplate();
	
	@Override
	public List<Movie> getAllMovies() {
		try {
			RequestMovie[] movies = restTemplate.getForObject(url, RequestMovie[].class);
			
			if(movies.length > 0) {
				List<Movie> allMovies = new ArrayList<>();
				for(RequestMovie movie:movies) {
					List<People> people = new ArrayList<>();
					
					for(String peopleId:movie.getPeople()) {
						People p = restTemplate.getForObject(peopleUrl.concat("/" + peopleId), People.class);
						people.add(p);
					}
					
					Movie newMovie = Movie.builder()
											.id(movie.getId())
											.title(movie.getTitle())
											.description(movie.getDescription())
											.director(movie.getDirector())
											.producer(movie.getProducer())
											.release_date(movie.getRelease_date())
											.rt_score(movie.getRt_score())
											.movie_banner(movie.getMovie_banner())
											.people(people)
											.build();
					allMovies.add(newMovie);
				}
				
				return allMovies;
			}
			
		} catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}

	@Override
	public Movie getMovieById(String id) {
		try {
			
			Movie movie = restTemplate.getForObject(url.concat("/" + id), Movie.class);
			
			if(movie == null) {
				return null;
			}
			
			return movie;
		} catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}

}
